@page "/admin/citas/crear"
@page "/admin/citas/editar/{CitaId:int}"
@layout MainLayoutAdm
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin, Usuario")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using ProyectoFinalJR.Models
@using ProyectoFinalJR.Services
@inject CitaService CitaService
@inject EventoDetalleService EventoService
@inject TipoProveedorService ProveedorService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(CitaId == 0 ? "Agendar" : "Editar") Cita/Reserva</PageTitle>

<div class="container-fluid">
    <EditForm EditContext="editContext" OnValidSubmit="Guardar">
        <DataAnnotationsValidator />

        <div class="card shadow-lg mx-auto" style="max-width: 650px;">
            <div class="card-header text-center text-white" style="background-color: #01206E;">
                <h5 class="card-title m-0">
                    <span class="bi bi-calendar-check me-2"></span>
                    @(CitaId == 0 ? "Agendar Nueva Cita" : $"Editar Cita ID: {Cita.CitaId}")
                </h5>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label"><strong>ID Cita</strong></label>
                        <InputNumber @bind-Value="Cita.CitaId" class="form-control" readonly />
                    </div>

                    <div class="col-md-8 mb-3">
                        <label class="form-label"><strong>Evento Asociado </strong></label>
                        <InputSelect @bind-Value="Cita.EventoId" class="form-select">
                            <option value="0">-- Seleccione Evento --</option>
                            @foreach (var evento in ListaEventos)
                            {
                                <option value="@evento.EventoId">@evento.Nombre (@evento.Fecha.ToShortDateString())</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="(() => Cita.EventoId)" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><strong>Fecha de la Cita </strong></label>
                        <InputDate @bind-Value="Cita.FechaCita" class="form-control" />
                        <ValidationMessage For="(() => Cita.FechaCita)" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><strong>Hora de la Cita </strong></label>
                        <InputText @bind-Value="Cita.HoraCita" class="form-control" placeholder="Ej: 14:30" />
                        <ValidationMessage For="(() => Cita.HoraCita)" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label"><strong>Proveedor Específico (Opcional)</strong></label>
                    <InputSelect @bind-Value="Cita.ProveedorId" class="form-select">
                        <option value="">-- Seleccione Proveedor --</option>
                        @foreach (var proveedor in ListaProveedores)
                        {
                            <option value="@proveedor.TipoProveedorId">@proveedor.Nombre</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="(() => Cita.ProveedorId)" />
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted">ID de Usuario Creador (UsuarioId)</label>
                    <InputText @bind-Value="Cita.UsuarioId" class="form-control form-control-sm" readonly />
                </div>
            </div>

            <div class="card-footer text-center d-flex justify-content-between">
                <a href="/admin/dashboard" class="btn btn-secondary">
                    <span class="bi bi-arrow-left"></span> Volver
                </a>
                <button type="submit" class="btn btn-success">
                    <span class="bi bi-floppy"></span> Guardar Cita
                </button>
            </div>
        </div>
    </EditForm>
</div>

<div class="modal @ModalConfirmClass" tabindex="-1" style="display:@ModalConfirmDisplay;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Confirmación de Cita</h5>
                <button type="button" class="btn-close" @onclick="CerrarModalConfirm"></button>
            </div>
            <div class="modal-body">
                @if (Cita.EventoId > 0)
                {
                    <p>Por favor, revisa los detalles de la cita antes de confirmar:</p>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item"><strong>Evento:</strong> @ListaEventos.FirstOrDefault(e => e.EventoId == Cita.EventoId)?.Nombre</li>
                        <li class="list-group-item"><strong>Fecha/Hora:</strong> @Cita.FechaCita.ToString("dd/MM/yyyy") @Cita.HoraCita</li>
                        <li class="list-group-item"><strong>Proveedor:</strong> @ListaProveedores.FirstOrDefault(p => p.TipoProveedorId == Cita.ProveedorId)?.Nombre</li>
                    </ul>

                    <p class="text-danger small">
                        ¿Confirmas el @(CitaId == 0 ? "agendamiento" : "guardado") de esta cita?
                    </p>
                }
                else
                {
                    <p class="text-danger">Debe seleccionar un evento válido para confirmar la cita.</p>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CerrarModalConfirm">Cancelar</button>
                <button type="button" class="btn btn-success" @onclick="ConfirmarGuardar" disabled="@(Cita.EventoId == 0)">
                    <span class="bi bi-floppy me-1"></span> @(CitaId == 0 ? "Agendar Cita" : "Guardar Cambios")
                </button>
            </div>
        </div>
    </div>
</div>

@if (ModalConfirmIsVisible)
{
    <div class="modal-backdrop fade show"></div>
}

<div class="modal @ModalSuccessClass" tabindex="-1" style="display:@ModalSuccessDisplay;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">¡Operación Exitosa!</h5>
                <button type="button" class="btn-close" @onclick="RedirigirDespuesDeExito"></button>
            </div>
            <div class="modal-body">
                <p><span class="bi bi-check-circle-fill text-success me-2"></span> La cita fue @(CitaId == 0 ? "agendada" : "actualizada") con éxito.</p>
                <p>Serás redirigido al Dashboard.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" @onclick="RedirigirDespuesDeExito">
                    Aceptar y Continuar
                </button>
            </div>
        </div>
    </div>
</div>

@if (ModalSuccessIsVisible)
{
    <div class="modal-backdrop fade show"></div>
}


@code {
    [Parameter]
    public int CitaId { get; set; }

    public Cita Cita { get; set; } = new Cita();
    private EditContext editContext = default!;

    public List<EventoDetalle> ListaEventos { get; set; } = new();
    public List<TipoProveedor> ListaProveedores { get; set; } = new();

    private string? currentUserId;
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;

    private bool ModalConfirmIsVisible { get; set; } = false;
    private string ModalConfirmDisplay => ModalConfirmIsVisible ? "block" : "none";
    private string ModalConfirmClass => ModalConfirmIsVisible ? "show" : "";

    private bool ModalSuccessIsVisible { get; set; } = false;
    private string ModalSuccessDisplay => ModalSuccessIsVisible ? "block" : "none";
    private string ModalSuccessClass => ModalSuccessIsVisible ? "show" : "";


    private void AbrirModalConfirm()
    {
        ModalConfirmIsVisible = true;
        StateHasChanged();
    }

    private void CerrarModalConfirm()
    {
        ModalConfirmIsVisible = false;
        StateHasChanged();
    }

    private void AbrirModalSuccess()
    {
        ModalSuccessIsVisible = true;
        StateHasChanged();
    }

    private void RedirigirDespuesDeExito()
    {
        navigationManager.NavigateTo("/admin/dashboard", forceLoad: true);
    }

    protected override void OnInitialized()
    {
        Cita.FechaCita = DateOnly.FromDateTime(DateTime.Now);
        editContext = new EditContext(Cita);
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await authenticationStateTask;
        var user = authState.User;
        currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        ListaEventos = await EventoService.GetList(e => true);
        ListaProveedores = await ProveedorService.GetList(p => true);

        if (CitaId > 0)
        {
            var encontrado = await CitaService.Buscar(CitaId);
            if (encontrado != null)
            {
                Cita = encontrado;
                editContext = new EditContext(Cita);
            }
            else
            {
                navigationManager.NavigateTo("/admin/citas");
            }
        }
        else if (currentUserId != null)
        {
            Cita = new Cita { FechaCita = DateOnly.FromDateTime(DateTime.Now), UsuarioId = currentUserId };
            editContext = new EditContext(Cita);
        }
        else
        {
            navigationManager.NavigateTo("/admin/dashboard");
        }
    }

    public void Guardar()
    {
        if (!editContext.Validate())
        {
            return;
        }

        if (string.IsNullOrEmpty(Cita.UsuarioId))
        {
            Cita.UsuarioId = currentUserId ?? "ErrorID";
        }

        AbrirModalConfirm();
    }

    public async Task ConfirmarGuardar()
    {
        CerrarModalConfirm();

        if (!editContext.Validate())
        {
            return;
        }

        var creado = await CitaService.Guardar(Cita);

        if (creado)
        {
            AbrirModalSuccess();
        }
    }
}