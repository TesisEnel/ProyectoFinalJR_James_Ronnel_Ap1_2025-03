@page "/Eventos/Crear"
@page "/admin/eventos/editar/{EventoId:int}"
@layout MainLayoutAdm
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin, Usuario")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using ProyectoFinalJR.Models
@using ProyectoFinalJR.Services
@inject EventoDetalleService EventoService
@inject TipoEventoService TipoEventoService
@inject TipoProveedorService TipoProveedorService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(EventoId == 0 ? "Crear" : "Editar") Evento</PageTitle>

<div class="container-fluid">
    <EditForm EditContext="editContext" OnValidSubmit="Guardar">
        <DataAnnotationsValidator />

        <div class="card shadow-lg mx-auto" style="max-width: 800px;">
            <div class="card-header text-center text-white" style="background-color: #01206E;">
                <h5 class="card-title m-0">
                    <span class="bi bi-calendar-check me-2"></span>
                    @(EventoId == 0 ? "Agendar Nuevo Evento" : $"Editar Evento: {Evento.Nombre}")
                </h5>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary border-bottom pb-2">Identificación y Tipos</h6>

                        <div class="mb-3">
                            <label class="form-label"><strong>ID de Evento</strong></label>
                            <InputNumber @bind-Value="Evento.EventoId" class="form-control" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>Tipo de Evento </strong></label>
                            <InputSelect @bind-Value="Evento.TipoEventoId" class="form-select">
                                <option value="0">-- Seleccione Tipo --</option>
                                @foreach (var tipo in TiposEventos)
                                {
                                    <option value="@tipo.TipoId">@tipo.Nombre</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="(() => Evento.TipoEventoId)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>Tipo de Proveedor (Opcional)</strong></label>
                            <InputSelect @bind-Value="Evento.TipoProveedorId" class="form-select">
                                <option value="">-- Seleccione Tipo de Proveedor --</option>
                                @foreach (var tipoProv in TiposProveedores)
                                {
                                    <option value="@tipoProv.TipoProveedorId">@tipoProv.Nombre</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="(() => Evento.TipoProveedorId)" />
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6 class="text-primary border-bottom pb-2">Tiempo y Finanzas</h6>

                        <div class="mb-3">
                            <label class="form-label"><strong>Nombre del Evento </strong></label>
                            <InputText class="form-control" @bind-Value="Evento.Nombre" placeholder="Ej: Boda de Juan y María" />
                            <ValidationMessage For="(() => Evento.Nombre)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>Presupuesto Inicial </strong></label>
                            <InputNumber class="form-control" @bind-Value="Evento.PresupuestoInicial" TValue="decimal" />
                            <ValidationMessage For="(() => Evento.PresupuestoInicial)" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Fecha </strong></label>
                                <InputDate @bind-Value="Evento.Fecha" class="form-control" />
                                <ValidationMessage For="(() => Evento.Fecha)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Hora </strong></label>
                                <InputText @bind-Value="Evento.Hora" class="form-control" placeholder="Ej: 19:00 o 7:00 PM" />
                                <ValidationMessage For="(() => Evento.Hora)" />
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="text-primary border-bottom pb-2 mt-2">Ubicación y Estado</h6>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label"><strong>Lugar </strong></label>
                        <InputText class="form-control" @bind-Value="Evento.Lugar" placeholder="Dirección o nombre del salón" />
                        <ValidationMessage For="(() => Evento.Lugar)" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label"><strong>Estado </strong></label>
                        <InputSelect @bind-Value="Evento.Estado" class="form-select" disabled="@(EventoId == 0)">

                            @if (EventoId == 0)
                            {
                                <option value="Pendiente">Pendiente</option>
                                <option value="Confirmado" disabled>Confirmado (Deshabilitado)</option>
                                <option value="Completado" disabled>Completado (Deshabilitado)</option>
                                <option value="Cancelado" disabled>Cancelado (Deshabilitado)</option>
                            }
                            else
                            {
                                <option value="Pendiente">Pendiente</option>
                                <option value="Confirmado">Confirmado</option>
                                <option value="Completado">Completado</option>
                                <option value="Cancelado">Cancelado</option>
                            }

                        </InputSelect>
                        <ValidationMessage For="(() => Evento.Estado)" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Descripción</strong></label>
                    <InputTextArea class="form-control" @bind-Value="Evento.Descripcion" rows="3" placeholder="Detalles, notas, requerimientos especiales..." />
                    <ValidationMessage For="(() => Evento.Descripcion)" />
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted">ID de Usuario Creador (UsuarioId)</label>
                    <InputText @bind-Value="Evento.UsuarioId" class="form-control form-control-sm" readonly />
                </div>
            </div>

            <div class="card-footer text-center d-flex justify-content-between">
                <a href="/admin/dashboard" class="btn btn-secondary">
                    <span class="bi bi-arrow-left"></span> Volver al Listado
                </a>
                <button type="submit" class="btn btn-success">
                    <span class="bi bi-floppy"></span> @(EventoId == 0 ? "Revisar y Agendar" : "Revisar y Guardar")
                </button>
            </div>
        </div>
    </EditForm>
</div>


<div class="modal @ModalClass" tabindex="-1" style="display:@ModalDisplay;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Confirmación de @(EventoId == 0 ? "Agendamiento" : "Edición")</h5>
                <button type="button" class="btn-close" @onclick="CerrarModal"></button>
            </div>
            <div class="modal-body">
                <p>Por favor, revisa los detalles del evento antes de confirmar la operación:</p>

                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item"><strong>Nombre:</strong> @Evento.Nombre</li>
                    <li class="list-group-item"><strong>Tipo:</strong> @(TiposEventos.FirstOrDefault(t => t.TipoId == Evento.TipoEventoId)?.Nombre ?? "N/A")</li>
                    <li class="list-group-item"><strong>Fecha y Hora:</strong> @Evento.Fecha.ToString("dd/MM/yyyy") a las @Evento.Hora</li>
                    <li class="list-group-item"><strong>Lugar:</strong> @Evento.Lugar</li>
                    <li class="list-group-item"><strong>Presupuesto:</strong> @Evento.PresupuestoInicial.ToString("C")</li>
                </ul>

                <p class="text-danger small">
                    ¿Confirmas el @(EventoId == 0 ? "agendamiento" : "guardado") de este evento con los detalles mostrados?
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CerrarModal">Cancelar</button>
                <button type="button" class="btn btn-success" @onclick="ConfirmarGuardar">
                    <span class="bi bi-floppy me-1"></span> @(EventoId == 0 ? "Agendar Evento" : "Guardar Cambios")
                </button>
            </div>
        </div>
    </div>
</div>
@if (ModalIsVisible)
{
    <div class="modal-backdrop fade show"></div>
}


@code {
    [Parameter]
    public int EventoId { get; set; }

    public EventoDetalle Evento { get; set; } = new EventoDetalle();
    private EditContext editContext = default!;

    public List<TipoEvento> TiposEventos { get; set; } = new();
    public List<TipoProveedor> TiposProveedores { get; set; } = new();

    private string? currentUserId;
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = default!;

    private bool ModalIsVisible { get; set; } = false;
    private string ModalDisplay => ModalIsVisible ? "block" : "none";
    private string ModalClass => ModalIsVisible ? "show" : "";

    private void AbrirModal()
    {
        ModalIsVisible = true;
        StateHasChanged();
    }

    private void CerrarModal()
    {
        ModalIsVisible = false;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        Evento.Fecha = DateOnly.FromDateTime(DateTime.Now);
        Evento.Estado = "Pendiente";
        editContext = new EditContext(Evento);
    }

    protected override async Task OnParametersSetAsync()
    {
        var authState = await authenticationStateTask;
        var user = authState.User;
        currentUserId = user.FindFirst(c => c.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;

        TiposEventos = await TipoEventoService.GetList(t => true);
        TiposProveedores = await TipoProveedorService.GetList(t => true);

        if (EventoId > 0)
        {
            var encontrado = await EventoService.Buscar(EventoId);
            if (encontrado != null)
            {
                Evento = encontrado;
                editContext = new EditContext(Evento);
            }
            else
            {
                navigationManager.NavigateTo("/admin/evento");
            }
        }
        else if (currentUserId != null)
        {
            Evento = new EventoDetalle
            {
                Fecha = DateOnly.FromDateTime(DateTime.Now),
                UsuarioId = currentUserId,
                Estado = "Pendiente"
            };
            editContext = new EditContext(Evento);
        }
        else
        {
            navigationManager.NavigateTo("/admin/evento");
        }
    }

    public void Guardar()
    {
        AbrirModal();
    }

    public async Task ConfirmarGuardar()
    {
        CerrarModal();

        if (string.IsNullOrEmpty(Evento.UsuarioId))
        {
            Evento.UsuarioId = currentUserId ?? "ErrorID";
        }

        var creado = await EventoService.Guardar(Evento);

        if (creado)
        {
            navigationManager.NavigateTo("/admin/dashboard", forceLoad: true);
        }
    }
}