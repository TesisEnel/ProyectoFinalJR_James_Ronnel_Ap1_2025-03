@page "/admin/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using ProyectoFinalJR.Models
@using ProyectoFinalJR.Services
@inject NavigationManager NavigationManager
@inject EventoDetalleService EventoService
@inject SugerenciaService SugerenciaService

@inherits LayoutComponentBase
@layout MainLayoutAdm

@attribute [Authorize(Roles = "Admin, Usuario")]

<PageTitle>Dashboard</PageTitle>

<div class="container-fluid">
    <AuthorizeView>
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Panel de @(context.User.IsInRole("Admin") ? "Administración" : "Usuario")</h1>
        </div>
    </AuthorizeView>

    @if (Cargando)
    {
        <div class="alert alert-info">Cargando datos del dashboard...</div>
    }
    else
    {
        <div class="row">

            <AuthorizeView Roles="Admin">
                <div class="col-xl-3 col-md-6 mb-4">
                    <a href="/admin/eventos" class="card-link-wrapper text-decoration-none">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Eventos Pendientes
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ConteoEventosPendientes</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-calendar-check fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </AuthorizeView>


            <AuthorizeView Roles="Admin">
                <div class="col-xl-3 col-md-6 mb-4">
                    <a href="/admin/sugerencias" class="card-link-wrapper text-decoration-none">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Sugerencias Nuevas
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ConteoSugerencias</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-chat-left-dots fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </AuthorizeView>

            <AuthorizeView Roles="Admin">
                @* Se muestra si el usuario es Admin *@
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Usuarios Registrados
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">@ConteoUsuarios</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-people-fill fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </AuthorizeView>

            <AuthorizeView Roles="Usuario">
                <div class="col-xl-3 col-md-6 mb-4">
                    <a href="/eventos" class="card-link-wrapper text-decoration-none">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            Agendar Nuevo Evento
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">Crear Evento</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-rocket fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </AuthorizeView>


        </div>
    }
</div>

@code {
    // Nota: Reemplazar EventoDetalle con el nombre real de tu modelo Evento
    // (Asumiré Evento es el modelo correcto si EventoDetalle no existe en tu Models namespace)
    public int ConteoEventosPendientes { get; set; } = 0;
    public int ConteoSugerencias { get; set; } = 0;
    public int ConteoUsuarios { get; set; } = 0;
    public bool Cargando { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // --- CONTEO DE EVENTOS PENDIENTES ---
            // Asumo que tu modelo Evento tiene una propiedad 'Estado' con valor "Pendiente"
            var listaEventos = await EventoService.GetList(e => e.Estado == "Pendiente");
            ConteoEventosPendientes = listaEventos?.Count ?? 0;

            // --- CONTEO DE SUGERENCIAS ---
            var listaSugerencias = await SugerenciaService.GetList(s => true);
            ConteoSugerencias = listaSugerencias?.Count ?? 0;

            // --- CONTEO DE USUARIOS (Simulado, ya que requiere UserManager o un servicio) ---
            // En una aplicación real, usarías el UserManager:
            // ConteoUsuarios = (await UserManager.GetUsersInRoleAsync("Usuario")).Count;
            ConteoUsuarios = 10; 

        }
        finally
        {
            Cargando = false;
        }
    }
}

<style>
    /* Estilo para que toda la tarjeta sea clickable */
    .card-link-wrapper {
        display: block;
        height: 100%;
        color: inherit; /* Mantener color de texto */
    }

        .card-link-wrapper .card {
            transition: transform 0.2s;
        }

        .card-link-wrapper:hover .card {
            transform: translateY(-3px);
        }
</style>